<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AOG Conference Asia 2025, Check In</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0a0e1a">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- QR scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" defer></script>

  <style>
    :root{
      --bg: #0a0e1a; --panel: #0f1424; --card: #1a1f2e; --muted: #94a3b8; --text: #f1f5f9;
      --brand: #6366f1; --brand-light: #818cf8; --brand-dark: #4f46e5; 
      --ok: #10b981; --err: #ef4444; --warn: #f59e0b;
      --ring: rgba(99,102,241,.4); --hair: rgba(255,255,255,.08);
      --radius: 20px; --shadow: 0 20px 40px rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.2);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:
        radial-gradient(1400px 700px at 15% -15%, rgba(99,102,241,.25), transparent 65%),
        radial-gradient(1000px 600px at 85% 15%, rgba(129,140,248,.2), transparent 65%),
        radial-gradient(800px 400px at 50% 100%, rgba(139,92,246,.15), transparent 70%),
        linear-gradient(180deg, #0a0e1a 0%, #0f1424 30%, #1a1f2e 100%);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100dvh;
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + 16px);
      overflow-x: hidden;
    }

    .shell{max-width:1200px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:20px}
    .header{
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(135deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--hair); border-radius:24px; padding:20px 24px; 
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,.05) inset;
      backdrop-filter: blur(12px);
      transition: all 0.3s ease;
    }
    .header:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 50px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08) inset;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px;
      font-size: clamp(20px, 4vw, 24px);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .logo{
      width: 40px; height: 40px; border-radius: 8px;
      object-fit: contain;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      transition: all 0.3s ease;
    }
    .logo:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,.3);
    }

    .grid{
      display:grid; gap:20px; grid-template-columns: 1fr;
    }
    @media(min-width:1024px){ .grid{ grid-template-columns: 1fr 1fr } }

    .card{
      background: linear-gradient(135deg, var(--card) 0%, rgba(26,31,46,.8) 100%);
      border:1px solid var(--hair);
      border-radius: var(--radius);
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,.03) inset;
      padding:24px;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 25px 50px rgba(0,0,0,.4), 0 0 0 1px rgba(255,255,255,.05) inset;
    }
    .card h3{
      margin:0 0 16px; font-size:18px; color:#e2e8f0; letter-spacing:.3px; 
      font-weight: 700;
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* scanner area */
    #reader{
      width:100%; aspect-ratio:1 / 1; border-radius:18px; overflow:hidden;
      background: linear-gradient(135deg, #0a0f1d 0%, #0f1424 100%); 
      border:1px solid rgba(255,255,255,.1);
      box-shadow: 0 8px 32px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.05) inset;
      transition: all 0.3s ease;
    }
    #reader:hover {
      border-color: rgba(99,102,241,.3);
      box-shadow: 0 12px 40px rgba(0,0,0,.4), 0 0 0 1px rgba(99,102,241,.1) inset;
    }

    .controls{
      display:grid; gap:12px; grid-template-columns: 1fr 1fr 1fr; margin-top:16px;
    }
    .controls.single{ grid-template-columns: 1fr }
    .controls.main-buttons{ grid-template-columns: 1fr 1fr }
    @media(max-width:560px){ 
      .controls{ grid-template-columns: 1fr } 
      .controls.main-buttons{ grid-template-columns: 1fr }
    }

    .btn, .filebtn{
      appearance:none; border:none; border-radius:16px; padding:16px 20px; 
      font-weight:700; cursor:pointer; line-height:1.2; width:100%; 
      font-size: 15px; letter-spacing: 0.3px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before, .filebtn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
      transition: left 0.5s ease;
    }
    .btn:hover::before, .filebtn:hover::before {
      left: 100%;
    }
    .btn.primary{ 
      background: var(--gradient-primary); 
      color:#fff; 
      box-shadow: 0 4px 16px rgba(99,102,241,.3);
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(99,102,241,.4);
    }
    .btn.ghost{ 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color:#e2e8f0; 
      border: 1px solid rgba(255,255,255,.1);
    }
    .btn.ghost:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .btn.warn{ 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
      color:#fff;
      box-shadow: 0 4px 16px rgba(245,158,11,.3);
    }
    .btn.warn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(245,158,11,.4);
    }
    .btn:disabled{ 
      opacity:.5; cursor:not-allowed; 
      transform: none !important;
      box-shadow: none !important;
    }
    .filebtn{ 
      position:relative; 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color:#e2e8f0; 
      text-align:center;
      border: 1px solid rgba(255,255,255,.1);
    }
    .filebtn:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .filebtn input{ position:absolute; inset:0; opacity:0; cursor:pointer }

    .hint{ 
      color:var(--muted); font-size:13px; text-align:center; margin-top:12px; 
      line-height: 1.4;
    }

    /* right column */
    .pill{ 
      display:inline-flex; align-items:center; gap:10px; padding:12px 16px; 
      border-radius:999px; 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color:#e2e8f0; font-size:13px; font-weight: 600;
      border:1px solid rgba(255,255,255,.1);
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
      transition: all 0.3s ease;
    }
    .pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
    }

    .kv{ display:grid; gap:12px; margin-top:16px }
    .kv-row{ 
      display:flex; gap:12px; align-items:flex-start; 
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    .kv-row:last-child { border-bottom: none; }
    .kv-key{ 
      min-width:100px; color:#94a3b8; font-weight: 600; font-size: 13px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .kv-val{ 
      flex:1; word-break:break-word; color:#f1f5f9; font-weight: 500;
      line-height: 1.4;
    }

    details.kv-more{ 
      margin-top:12px; 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
      border:1px solid rgba(255,255,255,.08); 
      border-radius:12px; 
      padding:12px 16px;
      transition: all 0.3s ease;
    }
    details.kv-more:hover {
      border-color: rgba(99,102,241,.2);
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    details.kv-more summary{ 
      cursor:pointer; color:#e2e8f0; font-weight:700; 
      padding: 4px 0;
      transition: color 0.3s ease;
    }
    details.kv-more summary:hover {
      color: #f1f5f9;
    }

    .chips{ display:flex; gap:12px; flex-wrap:wrap; margin-top:16px }
    .chip{
      display:inline-flex; align-items:center; gap:10px; padding:12px 16px; 
      border-radius:999px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color:#e2e8f0; border:1px solid rgba(255,255,255,.1); 
      cursor:pointer; font-weight: 600; font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .chip:hover {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      border-color: rgba(99,102,241,.3);
    }
    .chip input{ accent-color: var(--brand) }

    .status{ 
      min-height:28px; margin-top:12px; font-weight:700; font-size: 14px;
      padding: 8px 12px; border-radius: 8px;
      transition: all 0.3s ease;
    }
    .ok{ 
      color: var(--ok); 
      background: rgba(16,185,129,.1); 
      border: 1px solid rgba(16,185,129,.2);
    } 
    .err{ 
      color: var(--err); 
      background: rgba(239,68,68,.1); 
      border: 1px solid rgba(239,68,68,.2);
    } 
    .warntext{ 
      color: var(--warn); 
      background: rgba(245,158,11,.1); 
      border: 1px solid rgba(245,158,11,.2);
    }

    .raw-toggle{ margin-top:12px }
    .raw{ 
      display:none; margin-top:8px; color:#cbd5e1; font-size:13px; 
      word-break:break-word; 
      background: rgba(15,23,42,.5);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.05);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .actionbar{
      position:sticky; bottom:0; z-index:10; margin-top:16px; padding:16px;
      background: linear-gradient(180deg, rgba(15,23,42,0) 0%, rgba(15,23,42,.95) 100%);
      border-radius: 16px; border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(12px);
      box-shadow: 0 -4px 24px rgba(0,0,0,.3);
    }
    .action-btns{ display:grid; gap:12px; grid-template-columns: 1fr 1fr }
    @media(max-width:560px){ .action-btns{ grid-template-columns: 1fr } }

    /* focus states */
    .btn:focus-visible, .filebtn:focus-visible, .chip:focus-within{
      outline: none; box-shadow: 0 0 0 3px var(--ring);
    }

    /* toast */
    .toast{
      pointer-events:none; position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      max-width:92vw; 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color:#f1f5f9; 
      border:1px solid rgba(255,255,255,.1); 
      border-radius:16px;
      padding:16px 20px; 
      box-shadow: 0 20px 40px rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.2); 
      opacity:0; 
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px);
      font-weight: 600;
    }
    .toast.show{ 
      opacity:1; 
      transform: translateX(-50%) translateY(-8px);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
      margin-top: 20px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      border-top: 1px solid rgba(255,255,255,.05);
    }
    .footer p {
      margin: 0;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="shell">

    <header class="header" role="banner">
      <div class="brand">
        <img src="Logo.png" alt="GMS KL Logo" class="logo" />
        <span>AOG Conference Asia 2025, Check In</span>
      </div>
    </header>

    <main class="grid" role="main" aria-label="Check in workspace">
      <!-- Left, scanner -->
      <section class="card" aria-labelledby="scanTitle">
        <h3 id="scanTitle">Scan or upload</h3>

        <div id="reader" aria-label="QR scanner area"></div>

        <div class="controls main-buttons" style="margin-top:12px">
          <button id="start"   class="btn primary">Start camera</button>
          <label class="filebtn">Attach file
            <input id="file" type="file" accept="image/jpeg,image/png" aria-label="Attach QR image">
          </label>
        </div>

        <div class="controls" style="margin-top:8px">
          <button id="stop"    class="btn ghost"   style="display:none">Stop camera</button>
          <button id="restart" class="btn ghost"   style="display:none">Refit view</button>
          <div></div>
        </div>

        <div class="hint">Allow the camera when asked, or attach a QR image file</div>
      </section>

      <!-- Right, review and action -->
      <section class="card" aria-labelledby="reviewTitle">
        <h3 id="reviewTitle">Review and check in</h3>

        <div id="pill" class="pill">Waiting for scan</div>

        <div id="kv" class="kv" style="display:none">
          <div class="kv-row"><div class="kv-key">Name</div><div id="kvName" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Uni</div><div id="kvUni" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Number</div><div id="kvPhone" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">CG</div><div id="kvCg" class="kv-val"></div></div>

          <details class="kv-more">
            <summary>More details</summary>
            <div class="kv" style="margin-top:8px">
              <div class="kv-row"><div class="kv-key">Timestamp</div><div id="kvTs" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Joined</div><div id="kvCgJ" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Name</div><div id="kvCgN" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Allergies</div><div id="kvAll" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Receipt</div><div id="kvRec" class="kv-val"></div></div>
            </div>
          </details>
        </div>

        <div class="raw-toggle">
          <label class="chip" style="background:#16203a">
            <input id="toggleRaw" type="checkbox"> Show raw text
          </label>
          <div id="raw" class="raw"></div>
        </div>

        <div class="chips" role="radiogroup" aria-label="Choose status column">
          <label class="chip"><input type="radio" name="target" value="toolkit" checked> Toolkit Status</label>
          <label class="chip"><input type="radio" name="target" value="event"> Event Status</label>
        </div>

        <div class="actionbar">
          <div class="action-btns">
            <button id="confirm" class="btn primary" disabled>Confirm check in</button>
            <button id="clear"   class="btn ghost">Clear</button>
          </div>
          <div id="status" class="status"></div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer class="footer">
    <p>Copyright by GMS KL, made by William Jonathan</p>
  </footer>

  <script>
    // API endpoint, Vercel will serve both index and API on the same origin
    const API_ENDPOINT = '/api/check-in';

    document.addEventListener('DOMContentLoaded', () => {
      // Controls
      const startBtn = document.getElementById('start');
      const stopBtn  = document.getElementById('stop');
      const refitBtn = document.getElementById('restart');
      const fileInp  = document.getElementById('file');
      const confirmBtn = document.getElementById('confirm');
      const clearBtn   = document.getElementById('clear');

      // UI bits
      const pill   = document.getElementById('pill');
      const kvWrap = document.getElementById('kv');
      const kvName = document.getElementById('kvName');
      const kvUni  = document.getElementById('kvUni');
      const kvPhone= document.getElementById('kvPhone');
      const kvCg   = document.getElementById('kvCg');
      const kvTs   = document.getElementById('kvTs');
      const kvCgJ  = document.getElementById('kvCgJ');
      const kvCgN  = document.getElementById('kvCgN');
      const kvAll  = document.getElementById('kvAll');
      const kvRec  = document.getElementById('kvRec');

      const rawToggle = document.getElementById('toggleRaw');
      const rawBox    = document.getElementById('raw');
      const statusEl  = document.getElementById('status');
      const toastEl   = document.getElementById('toast');

      // Scanner
      let scanner = null, running = false, lastScan = '';
      let currentCameraId = null, resizeTimer = null;

      function readerSize(){
        const el = document.getElementById('reader');
        const w = el.clientWidth || window.innerWidth;
        return Math.max(240, Math.min(640, Math.floor(w * 0.92)));
      }

      function showToast(text){
        toastEl.textContent = text || '';
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 1600);
      }

      function parsePayload(s){
        let p = String(s || '').trim();
        try { const u = new URL(p); const d = u.searchParams.get('data'); if (d) p = decodeURIComponent(d); } catch(_){}
        p = p.replace(/\s*\|\s*/g, ' | ').replace(/\s+/g, ' ').trim();
        const parts = p.split(' | '); while (parts.length < 8) parts.push('');
        const [ts, name, phone, uni, cgJoined, cgName, allergy, receipt] = parts;
        let cgDisplay = cgJoined;
        if (/^y/i.test(cgJoined)) cgDisplay = cgName ? ('Yes, ' + cgName) : 'Yes';
        else if (/^n/i.test(cgJoined)) cgDisplay = 'No';
        else if (cgName) cgDisplay = cgName;
        return { raw:s, payload:p, ts, name, phone, uni, cgJoined, cgName, allergy, receipt, cgDisplay };
      }

      function setReview(text){
        if (!text){
          pill.textContent = 'Waiting for scan';
          kvWrap.style.display = 'none';
          confirmBtn.disabled = true;
          rawBox.textContent = '';
          rawBox.style.display = 'none';
          rawToggle.checked = false;
          statusEl.textContent = '';
          statusEl.className = 'status';
          return;
        }
        const f = parsePayload(text);
        pill.textContent = 'Scanned';
        kvName.textContent  = f.name || '–';
        kvUni.textContent   = f.uni || '–';
        kvPhone.textContent = f.phone || '–';
        kvCg.textContent    = f.cgDisplay || '–';
        kvTs.textContent    = f.ts || '–';
        kvCgJ.textContent   = f.cgJoined || '–';
        kvCgN.textContent   = f.cgName || '–';
        kvAll.textContent   = f.allergy || '–';
        kvRec.textContent   = f.receipt || '–';
        kvWrap.style.display = '';
        rawBox.textContent = f.payload;
        confirmBtn.disabled = false;
        statusEl.textContent = '';
        statusEl.className = 'status';
      }

      rawToggle.addEventListener('change', () => {
        rawBox.style.display = rawToggle.checked ? 'block' : 'none';
      });

      function onScanSuccess(text){
        lastScan = text;
        setReview(text);
        showToast('QR captured');
      }
      function onScanFailure(_){ /* keep it quiet to avoid noise */ }

      async function chooseCameraId(){
        try {
          const cams = await Html5Qrcode.getCameras();
          if (!cams || !cams.length) return null;
          const back = cams.find(c => /back|rear|environment/i.test(c.label));
          return back ? back.id : cams[0].id;
        } catch { return null; }
      }

      async function startCamera(){
        try{
          const size = readerSize();
          if (!scanner) scanner = new Html5Qrcode('reader');
          currentCameraId = await chooseCameraId();
          const config = {
            fps: 12, qrbox: { width:size, height:size }, aspectRatio: 1.0,
            rememberLastUsedCamera:false, showTorchButtonIfSupported:true,
            defaultZoomValueIfSupported:2, disableFlip:true,
            formatsToSupport:[ Html5QrcodeSupportedFormats.QR_CODE ],
            experimentalFeatures:{ useBarCodeDetectorIfSupported:true }
          };
          if (currentCameraId) await scanner.start(currentCameraId, config, onScanSuccess, onScanFailure);
          else await scanner.start({ facingMode:'environment' }, config, onScanSuccess, onScanFailure);
          running = true;
          startBtn.style.display = 'none';
          stopBtn.style.display  = 'block';
          refitBtn.style.display = 'block';
          pill.textContent = 'Camera active';
          statusEl.textContent = '';
          statusEl.className = 'status';
        }catch(e){
          statusEl.textContent = 'Camera error, ' + e.message;
          statusEl.className = 'status err';
        }
      }

      async function stopCamera(){
        if (scanner && running){
          try { await scanner.stop(); } catch {}
          running = false;
          startBtn.style.display = 'block';
          stopBtn.style.display  = 'none';
          refitBtn.style.display = 'none';
          pill.textContent = 'Camera stopped';
        }
      }

      async function refitCamera(){
        if (!running) return;
        await stopCamera();
        await startCamera();
      }

      startBtn.addEventListener('click', startCamera);
      stopBtn.addEventListener('click', stopCamera);
      refitBtn.addEventListener('click', refitCamera);

      const scheduleRefit = () => {
        if (!running) return;
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(refitCamera, 250);
      };
      window.addEventListener('resize', scheduleRefit);
      window.addEventListener('orientationchange', scheduleRefit);
      document.addEventListener('visibilitychange', () => { if (document.hidden) stopCamera(); });

      // File scanning
      fileInp.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          if (!/image\/jpeg|image\/jpg|image\/png/i.test(file.type)){
            statusEl.textContent = 'Unsupported image, pick JPG or PNG';
            statusEl.className = 'status err';
            fileInp.value = '';
            return;
          }
          if (scanner && running) await stopCamera();
          if (!scanner) scanner = new Html5Qrcode('reader');
          const text = await scanner.scanFile(file, true);
          onScanSuccess(text);
        }catch(err){
          statusEl.textContent = 'File scan failed, ' + (err && err.message ? err.message : 'unknown error');
          statusEl.className = 'status err';
        }finally{
          fileInp.value = '';
        }
      });

      // API call
      async function postCheckIn(scannedText, target){
        const r = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ scannedText, target })
        });
        return r.json();
      }

      // Confirm
      confirmBtn.addEventListener('click', async () => {
        if (!lastScan) return;
        const target = document.querySelector('input[name="target"]:checked').value;
        confirmBtn.disabled = true;
        statusEl.textContent = 'Updating, please wait';
        statusEl.className = 'status warntext';
        try{
          const res = await postCheckIn(lastScan, target);
          statusEl.textContent = res.message || 'Done';
          statusEl.className = res.ok ? 'status ok' : 'status err';
          if (res.ok && /Checked in row/.test(res.message)){
            lastScan = '';
            setReview('');
            showToast('Checked in');
          } else {
            confirmBtn.disabled = false;
          }
        }catch(err){
          statusEl.textContent = 'Network error, ' + err.message;
          statusEl.className = 'status err';
          confirmBtn.disabled = false;
        }
      });

      // Clear
      clearBtn.addEventListener('click', () => { lastScan = ''; setReview(''); showToast('Cleared'); });

      // Init
      setReview('');
    });
  </script>
</body>
</html>
