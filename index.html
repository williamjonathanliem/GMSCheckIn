<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AOG Conference Asia 2025, Check In</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0b0f1a">
  <!-- QR scanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" defer></script>

  <style>
    :root{
      --bg:#0b0f1a; --panel:#0f1424; --card:#121a2b; --muted:#9aa3b2; --text:#e5e7eb;
      --brand:#4f46e5; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --ring: rgba(79,70,229,.45); --hair: rgba(255,255,255,.06);
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:
        radial-gradient(1200px 600px at 20% -20%, rgba(79,70,229,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(59,130,246,.14), transparent 60%),
        linear-gradient(180deg,#0b0f1a, #0e1627 40%, #0b1322);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      min-height: 100dvh;
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + 12px);
    }

    .shell{max-width:1120px; margin:0 auto; padding:14px; display:flex; flex-direction:column; gap:14px}
    .header{
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--hair); border-radius:20px; padding:12px 14px; box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;
      font-size: clamp(18px, 3.8vw, 22px);
    }
    .brand-badge{
      width:28px; height:28px; border-radius:8px; background: conic-gradient(from 160deg, #4f46e5, #22c55e, #4f46e5);
      box-shadow: 0 0 0 2px rgba(255,255,255,.06) inset;
    }

    .grid{
      display:grid; gap:14px; grid-template-columns: 1fr;
    }
    @media(min-width:1024px){ .grid{ grid-template-columns: 1fr 1fr } }

    .card{
      background: var(--card);
      border:1px solid var(--hair);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px; color:#cbd5e1; letter-spacing:.2px}

    /* scanner area */
    #reader{
      width:100%; aspect-ratio:1 / 1; border-radius:14px; overflow:hidden;
      background:#0a0f1d; border:1px solid rgba(255,255,255,.08);
    }

    .controls{
      display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr; margin-top:12px;
    }
    .controls.single{ grid-template-columns: 1fr }
    @media(max-width:560px){ .controls{ grid-template-columns: 1fr } }

    .btn, .filebtn{appearance:none; border:none; border-radius:12px; padding:14px; font-weight:800; cursor:pointer; line-height:1; width:100%}
    .btn.primary{ background: var(--brand); color:#fff; }
    .btn.ghost{ background:#243052; color:#e5e7eb; }
    .btn.warn{ background:#312e1f; color:#fef3c7 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .filebtn{ position:relative; background:#243052; color:#e5e7eb; text-align:center }
    .filebtn input{ position:absolute; inset:0; opacity:0; cursor:pointer }

    .hint{ color:var(--muted); font-size:12px; text-align:center; margin-top:6px }

    /* right column */
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#182241; color:#cdd5e5; font-size:12px; border:1px solid var(--hair) }

    .kv{ display:grid; gap:10px; margin-top:12px }
    .kv-row{ display:flex; gap:10px; align-items:flex-start }
    .kv-key{ min-width:90px; color:#a6b0c2 }
    .kv-val{ flex:1; word-break:break-word; color:#e5e7eb }

    details.kv-more{ margin-top:6px; background:#101a33; border:1px solid var(--hair); border-radius:10px; padding:8px 10px }
    details.kv-more summary{ cursor:pointer; color:#cbd5e1; font-weight:700 }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px;
      background:#16203a; color:#d2dcf2; border:1px solid var(--hair); cursor:pointer;
    }
    .chip input{ accent-color: var(--brand) }

    .status{ min-height:24px; margin-top:10px; font-weight:800 }
    .ok{ color: var(--ok) } .err{ color: var(--err) } .warntext{ color: var(--warn) }

    .raw-toggle{ margin-top:8px }
    .raw{ display:none; margin-top:6px; color:#cbd5e1; font-size:13px; word-break:break-word }

    .actionbar{
      position:sticky; bottom:0; z-index:10; margin-top:12px; padding:10px;
      background: linear-gradient(180deg, rgba(13,18,34,0), rgba(13,18,34,.96));
      border-radius: 12px; border: 1px solid var(--hair);
      backdrop-filter: blur(6px);
    }
    .action-btns{ display:grid; gap:10px; grid-template-columns: 1fr 1fr }
    @media(max-width:560px){ .action-btns{ grid-template-columns: 1fr } }

    /* focus states */
    .btn:focus-visible, .filebtn:focus-visible, .chip:focus-within{
      outline: none; box-shadow: 0 0 0 3px var(--ring);
    }

    /* toast */
    .toast{
      pointer-events:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      max-width:92vw; background:#0e1630; color:#e5e7eb; border:1px solid var(--hair); border-radius:12px;
      padding:10px 12px; box-shadow: var(--shadow); opacity:0; transition: opacity .25s ease;
    }
    .toast.show{ opacity:1 }
  </style>
</head>
<body>
  <div class="shell">

    <header class="header" role="banner">
      <div class="brand">
        <span class="brand-badge" aria-hidden="true"></span>
        <span>AOG Conference Asia 2025, Check In</span>
      </div>
      <div class="hint" style="margin:0">Camera not allowed, use Attach file</div>
    </header>

    <main class="grid" role="main" aria-label="Check in workspace">
      <!-- Left, scanner -->
      <section class="card" aria-labelledby="scanTitle">
        <h3 id="scanTitle">Scan or upload</h3>

        <div id="reader" aria-label="QR scanner area"></div>

        <div class="controls" style="margin-top:12px">
          <button id="start"   class="btn primary">Start camera</button>
          <button id="stop"    class="btn ghost"   style="display:none">Stop camera</button>
          <button id="restart" class="btn ghost"   style="display:none">Refit view</button>
        </div>

        <div class="controls single">
          <label class="filebtn">Attach file
            <input id="file" type="file" accept="image/jpeg,image/png" capture="environment">
          </label>
        </div>

        <div class="hint">Allow the camera when asked, or attach a QR image file</div>
      </section>

      <!-- Right, review and action -->
      <section class="card" aria-labelledby="reviewTitle">
        <h3 id="reviewTitle">Review and check in</h3>

        <div id="pill" class="pill">Waiting for scan</div>

        <div id="kv" class="kv" style="display:none">
          <div class="kv-row"><div class="kv-key">Name</div><div id="kvName" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Uni</div><div id="kvUni" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">Number</div><div id="kvPhone" class="kv-val"></div></div>
          <div class="kv-row"><div class="kv-key">CG</div><div id="kvCg" class="kv-val"></div></div>

          <details class="kv-more">
            <summary>More details</summary>
            <div class="kv" style="margin-top:8px">
              <div class="kv-row"><div class="kv-key">Timestamp</div><div id="kvTs" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Joined</div><div id="kvCgJ" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">CG Name</div><div id="kvCgN" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Allergies</div><div id="kvAll" class="kv-val"></div></div>
              <div class="kv-row"><div class="kv-key">Receipt</div><div id="kvRec" class="kv-val"></div></div>
            </div>
          </details>
        </div>

        <div class="raw-toggle">
          <label class="chip" style="background:#16203a">
            <input id="toggleRaw" type="checkbox"> Show raw text
          </label>
          <div id="raw" class="raw"></div>
        </div>

        <div class="chips" role="radiogroup" aria-label="Choose status column">
          <label class="chip"><input type="radio" name="target" value="toolkit" checked> Toolkit Status</label>
          <label class="chip"><input type="radio" name="target" value="event"> Event Status</label>
        </div>

        <div class="actionbar">
          <div class="action-btns">
            <button id="confirm" class="btn primary" disabled>Confirm check in</button>
            <button id="clear"   class="btn ghost">Clear</button>
          </div>
          <div id="status" class="status"></div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // API endpoint, Vercel will serve both index and API on the same origin
    const API_ENDPOINT = '/api/check-in';

    document.addEventListener('DOMContentLoaded', () => {
      // Controls
      const startBtn = document.getElementById('start');
      const stopBtn  = document.getElementById('stop');
      const refitBtn = document.getElementById('restart');
      const fileInp  = document.getElementById('file');
      const confirmBtn = document.getElementById('confirm');
      const clearBtn   = document.getElementById('clear');

      // UI bits
      const pill   = document.getElementById('pill');
      const kvWrap = document.getElementById('kv');
      const kvName = document.getElementById('kvName');
      const kvUni  = document.getElementById('kvUni');
      const kvPhone= document.getElementById('kvPhone');
      const kvCg   = document.getElementById('kvCg');
      const kvTs   = document.getElementById('kvTs');
      const kvCgJ  = document.getElementById('kvCgJ');
      const kvCgN  = document.getElementById('kvCgN');
      const kvAll  = document.getElementById('kvAll');
      const kvRec  = document.getElementById('kvRec');

      const rawToggle = document.getElementById('toggleRaw');
      const rawBox    = document.getElementById('raw');
      const statusEl  = document.getElementById('status');
      const toastEl   = document.getElementById('toast');

      // Scanner
      let scanner = null, running = false, lastScan = '';
      let currentCameraId = null, resizeTimer = null;

      function readerSize(){
        const el = document.getElementById('reader');
        const w = el.clientWidth || window.innerWidth;
        return Math.max(240, Math.min(640, Math.floor(w * 0.92)));
      }

      function showToast(text){
        toastEl.textContent = text || '';
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 1600);
      }

      function parsePayload(s){
        let p = String(s || '').trim();
        try { const u = new URL(p); const d = u.searchParams.get('data'); if (d) p = decodeURIComponent(d); } catch(_){}
        p = p.replace(/\s*\|\s*/g, ' | ').replace(/\s+/g, ' ').trim();
        const parts = p.split(' | '); while (parts.length < 8) parts.push('');
        const [ts, name, phone, uni, cgJoined, cgName, allergy, receipt] = parts;
        let cgDisplay = cgJoined;
        if (/^y/i.test(cgJoined)) cgDisplay = cgName ? ('Yes, ' + cgName) : 'Yes';
        else if (/^n/i.test(cgJoined)) cgDisplay = 'No';
        else if (cgName) cgDisplay = cgName;
        return { raw:s, payload:p, ts, name, phone, uni, cgJoined, cgName, allergy, receipt, cgDisplay };
      }

      function setReview(text){
        if (!text){
          pill.textContent = 'Waiting for scan';
          kvWrap.style.display = 'none';
          confirmBtn.disabled = true;
          rawBox.textContent = '';
          rawBox.style.display = 'none';
          rawToggle.checked = false;
          statusEl.textContent = '';
          statusEl.className = 'status';
          return;
        }
        const f = parsePayload(text);
        pill.textContent = 'Scanned';
        kvName.textContent  = f.name || '–';
        kvUni.textContent   = f.uni || '–';
        kvPhone.textContent = f.phone || '–';
        kvCg.textContent    = f.cgDisplay || '–';
        kvTs.textContent    = f.ts || '–';
        kvCgJ.textContent   = f.cgJoined || '–';
        kvCgN.textContent   = f.cgName || '–';
        kvAll.textContent   = f.allergy || '–';
        kvRec.textContent   = f.receipt || '–';
        kvWrap.style.display = '';
        rawBox.textContent = f.payload;
        confirmBtn.disabled = false;
        statusEl.textContent = '';
        statusEl.className = 'status';
      }

      rawToggle.addEventListener('change', () => {
        rawBox.style.display = rawToggle.checked ? 'block' : 'none';
      });

      function onScanSuccess(text){
        lastScan = text;
        setReview(text);
        showToast('QR captured');
      }
      function onScanFailure(_){ /* keep it quiet to avoid noise */ }

      async function chooseCameraId(){
        try {
          const cams = await Html5Qrcode.getCameras();
          if (!cams || !cams.length) return null;
          const back = cams.find(c => /back|rear|environment/i.test(c.label));
          return back ? back.id : cams[0].id;
        } catch { return null; }
      }

      async function startCamera(){
        try{
          const size = readerSize();
          if (!scanner) scanner = new Html5Qrcode('reader');
          currentCameraId = await chooseCameraId();
          const config = {
            fps: 12, qrbox: { width:size, height:size }, aspectRatio: 1.0,
            rememberLastUsedCamera:false, showTorchButtonIfSupported:true,
            defaultZoomValueIfSupported:2, disableFlip:true,
            formatsToSupport:[ Html5QrcodeSupportedFormats.QR_CODE ],
            experimentalFeatures:{ useBarCodeDetectorIfSupported:true }
          };
          if (currentCameraId) await scanner.start(currentCameraId, config, onScanSuccess, onScanFailure);
          else await scanner.start({ facingMode:'environment' }, config, onScanSuccess, onScanFailure);
          running = true;
          startBtn.style.display = 'none';
          stopBtn.style.display  = 'block';
          refitBtn.style.display = 'block';
          pill.textContent = 'Camera active';
          statusEl.textContent = '';
          statusEl.className = 'status';
        }catch(e){
          statusEl.textContent = 'Camera error, ' + e.message;
          statusEl.className = 'status err';
        }
      }

      async function stopCamera(){
        if (scanner && running){
          try { await scanner.stop(); } catch {}
          running = false;
          startBtn.style.display = 'block';
          stopBtn.style.display  = 'none';
          refitBtn.style.display = 'none';
          pill.textContent = 'Camera stopped';
        }
      }

      async function refitCamera(){
        if (!running) return;
        await stopCamera();
        await startCamera();
      }

      startBtn.addEventListener('click', startCamera);
      stopBtn.addEventListener('click', stopCamera);
      refitBtn.addEventListener('click', refitCamera);

      const scheduleRefit = () => {
        if (!running) return;
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(refitCamera, 250);
      };
      window.addEventListener('resize', scheduleRefit);
      window.addEventListener('orientationchange', scheduleRefit);
      document.addEventListener('visibilitychange', () => { if (document.hidden) stopCamera(); });

      // File scanning
      fileInp.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          if (!/image\/jpeg|image\/jpg|image\/png/i.test(file.type)){
            statusEl.textContent = 'Unsupported image, pick JPG or PNG';
            statusEl.className = 'status err';
            fileInp.value = '';
            return;
          }
          if (scanner && running) await stopCamera();
          if (!scanner) scanner = new Html5Qrcode('reader');
          const text = await scanner.scanFile(file, true);
          onScanSuccess(text);
        }catch(err){
          statusEl.textContent = 'File scan failed, ' + (err && err.message ? err.message : 'unknown error');
          statusEl.className = 'status err';
        }finally{
          fileInp.value = '';
        }
      });

      // API call
      async function postCheckIn(scannedText, target){
        const r = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ scannedText, target })
        });
        return r.json();
      }

      // Confirm
      confirmBtn.addEventListener('click', async () => {
        if (!lastScan) return;
        const target = document.querySelector('input[name="target"]:checked').value;
        confirmBtn.disabled = true;
        statusEl.textContent = 'Updating, please wait';
        statusEl.className = 'status warntext';
        try{
          const res = await postCheckIn(lastScan, target);
          statusEl.textContent = res.message || 'Done';
          statusEl.className = res.ok ? 'status ok' : 'status err';
          if (res.ok && /Checked in row/.test(res.message)){
            lastScan = '';
            setReview('');
            showToast('Checked in');
          } else {
            confirmBtn.disabled = false;
          }
        }catch(err){
          statusEl.textContent = 'Network error, ' + err.message;
          statusEl.className = 'status err';
          confirmBtn.disabled = false;
        }
      });

      // Clear
      clearBtn.addEventListener('click', () => { lastScan = ''; setReview(''); showToast('Cleared'); });

      // Init
      setReview('');
    });
  </script>
</body>
</html>
